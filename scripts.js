function dispatchMessage(e,t,s){window.dispatchMessages([{type:e,text:t}],s)}function initSankakuTools(){return{API_URL:"https://capi-v2.sankakucomplex.com",LOGIN_URL:"https://capi-v2.sankakucomplex.com/auth/token",TAG_WIKI_URL:"https://capi-v2.sankakucomplex.com/tag-and-wiki/name/",FOLLOWING_URL:"https://sankakuapi.com/users/followings?lang=en",isLoading:!1,formData:{login:"",password:""},selectedFile:null,token_type:"",access_token:"",refresh_token:"",access_token_ttl:0,refresh_token_ttl:0,hasToken:!1,copied:!1,accessTokenExpiryDate:null,refreshTokenExpiryDate:null,tags:[],followingTags:[],lastFetchFollowingTagsTime:null,initialized:!1,sortBy:"",sortDesc:!1,selectedTags:[],recentlyUnfollowedTags:[],selectedAll:!1,selectedFollowFilter:"all",selectedFetchFilter:"all",filteredTags:[],init(){if(this.initialized)return;this.initialized=!0;let e=localStorage.getItem("skk_token_type"),t=localStorage.getItem("skk_access_token"),s=localStorage.getItem("skk_refresh_token"),i=localStorage.getItem("skk_access_token_expiry"),a=localStorage.getItem("skk_refresh_token_expiry");e&&t&&s&&(this.token_type=e,this.access_token=t,this.refresh_token=s,this.accessTokenExpiryDate=new Date(i),this.refreshTokenExpiryDate=new Date(a),this.hasToken=!0,this.checkTokenExpiry()),this.getLocalStorageForTags(),this.getLastFetchTime()>300&&this.dispatchMessage("warning","Last fetch was more than 5 minutes ago. You should fetch following tags again.",5e3)},getLocalStorageForTags(){let e=localStorage.getItem("localTags");e&&(this.tags=JSON.parse(e).map(e=>({id:e.id??null,name:e.name,fetched:e.fetched??null,following:e.following??!1})));let t=localStorage.getItem("followingTags");t&&(this.followingTags=JSON.parse(t));let s=localStorage.getItem("lastFetchFollowingTagsTime");s&&(this.lastFetchFollowingTagsTime=s);let i=localStorage.getItem("recentlyUnfollowedTags");i&&(this.recentlyUnfollowedTags=JSON.parse(i)),this.filteredTags=this.tags},updateLocalStorageForTags(){localStorage.setItem("localTags",JSON.stringify(this.tags)),localStorage.setItem("followingTags",JSON.stringify(this.followingTags)),localStorage.setItem("lastFetchFollowingTagsTime",this.lastFetchFollowingTagsTime),localStorage.setItem("recentlyUnfollowedTags",JSON.stringify(this.recentlyUnfollowedTags))},dispatchMessage(e,t,s){window.dispatchMessages([{type:e,text:t}],s)},getToken(){this.isLoading=!0,fetch(this.LOGIN_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.formData)}).then(e=>{if(e.redirected)window.location.href=e.url;else{if(e.ok)return e.json();this.dispatchMessage("warning","Something went wrong. Please try again later!",5e3),this.isLoading=!1}}).then(e=>{if(this.isLoading=!1,e.success&&e.token_type&&e.access_token&&e.refresh_token){this.token_type=e.token_type,this.access_token=e.access_token,this.refresh_token=e.refresh_token,this.access_token_ttl=e.access_token_ttl,this.refresh_token_ttl=e.refresh_token_ttl,localStorage.setItem("skk_token_type",this.token_type),localStorage.setItem("skk_access_token",this.access_token),localStorage.setItem("skk_refresh_token",this.refresh_token);let t=new Date;this.accessTokenExpiryDate=new Date(t.getTime()+1e3*this.access_token_ttl),this.refreshTokenExpiryDate=new Date(t.getTime()+1e3*this.refresh_token_ttl),localStorage.setItem("skk_access_token_expiry",this.accessTokenExpiryDate),localStorage.setItem("skk_refresh_token_expiry",this.refreshTokenExpiryDate),this.hasToken=!0,this.dispatchMessage("success","Login successful! Tokens saved.",5e3),this.checkTokenExpiry()}else this.dispatchMessage("warning","Invalid credentials or unknown error!",5e3)}).catch(e=>{console.error("Error:",e),this.isLoading=!1})},checkTokenExpiry(){let e=new Date;if(this.accessTokenExpiryDate){let t=Math.round((this.accessTokenExpiryDate-e)/1e3);t<=0?(this.dispatchMessage("warning","Access token has expired. Please log in again.",5e3),this.hasToken=!1):t<=3600&&this.dispatchMessage("warning",`Access token will expire in ${Math.round(t/60)} minutes.`,5e3)}if(this.refreshTokenExpiryDate){let s=Math.round((this.refreshTokenExpiryDate-e)/1e3);s<=0?(this.dispatchMessage("warning","Refresh token has expired. Please log in again.",5e3),this.hasToken=!1):s<=86400&&this.dispatchMessage("warning",`Refresh token will expire in ${Math.round(s/3600)} hours.`,5e3)}},copyToken(){let e=this.$refs.token.textContent;if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(e).catch(e=>{console.error("Error copying token: ",e)});else{let t=document.createElement("textarea");t.value=e,t.style.position="absolute",t.style.left="-9999px",document.body.appendChild(t),t.select();try{document.execCommand("copy"),this.dispatchMessage("success","Token copied!",5e3)}catch(s){console.error("Fallback: Error copying token",s)}document.body.removeChild(t)}},copyRefreshToken(){let e=this.$refs.refreshToken.textContent;if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(e).catch(e=>{console.error("Error copying token: ",e)});else{let t=document.createElement("textarea");t.value=e,t.style.position="absolute",t.style.left="-9999px",document.body.appendChild(t),t.select();try{document.execCommand("copy"),this.dispatchMessage("success","Refresh Token copied!",5e3)}catch(s){console.error("Fallback: Error copying refresh token",s)}document.body.removeChild(t)}},handleFileUpload(e){this.selectedFile=e.target.files[0]},processFile(){if(!this.selectedFile){this.dispatchMessage("warning","Please select a file!",5e3);return}this.isLoading=!0;let e=new FileReader;e.onload=e=>{let t=e.target.result.split("\n");t.forEach(e=>{let t=e.trim();if(t&&!t.startsWith("#")&&!t.startsWith("//")){let s=t.toLowerCase();this.tags.some(e=>e.name.toLowerCase()===s)||this.tags.push({name:s,fetched:!1,following:!1})}}),this.updateLocalStorageForTags()},e.readAsText(this.selectedFile),this.isLoading=!1},fetchTagWiki(e,t=!1){if(!t){if(!0===e.fetched){this.dispatchMessage("warning","Tag already fetched!",5e3);return}this.isLoading=!0,fetch(this.TAG_WIKI_URL+e.name,{method:"GET"}).then(e=>{if(e.redirected)window.location.href=e.url;else if(e.ok)return e.json();else throw Error("Tag not found or something went wrong!")}).then(s=>{if(s.tag){console.log(s.tag);let i=s.tag.id;this.tags=this.tags.map(t=>(t.name===e.name&&(t.fetched=!0,t.id=i),t)),this.updateLocalStorageForTags(),t||this.dispatchMessage("success","Tags fetching status updated!",5e3),this.checkTokenExpiry()}else t||this.dispatchMessage("warning","Unknown error!",5e3);t||(this.isLoading=!1)}).catch(s=>{console.error("Error:",s),t||this.dispatchMessage("warning",s.message,5e3),this.tags=this.tags.map(t=>(t.name===e.name&&(t.fetched=null,t.id=null,t.follwing=null),t)),this.updateLocalStorageForTags(),t||(this.isLoading=!1)})}},refreshAllTags(){if(!confirm("Do you want to refresh all tags?"))return;this.isLoading=!0,console.log("Refreshing all tags");let e=0,t=()=>{let s=this.tags.slice(e,e+10),i=s.map(e=>this.fetchTagWiki(e,!0));Promise.all(i).then(()=>{(e+=10)<this.tags.length?setTimeout(t,2e3):(this.isLoading=!1,this.dispatchMessage("success","All tags refreshed!",5e3))}).catch(e=>{console.error("Error in refreshing tags:",e),this.dispatchMessage("warning","Some tags could not be refreshed.",5e3),this.isLoading=!1})};t()},getTagPostsUrl:e=>e.postsUrl||`https://www.sankakucomplex.com/?tags=${e.name}`,getTagWikiUrl:e=>e.wikiUrl||`https://www.sankakucomplex.com/tag?tagName=${e.name}`,fetchFollowingTags(){this.isLoading=!0,fetch(this.FOLLOWING_URL,{method:"GET",headers:{Authorization:`Bearer ${this.access_token}`,"Content-Type":"application/json"}}).then(e=>{if(e.redirected)window.location.href=e.url;else if(e.ok)return e.json();else throw Error("Token expired or something went wrong!")}).then(e=>{e.tags?(this.followingTags=e.tags.map(e=>({id:e.id,name:e.name_en||e.name_ja||e.name,following:!0})),this.followingTags.forEach(e=>{let t=this.tags.find(t=>t.id===e.id);t?t.following=!0:this.tags.push({id:e.id,name:e.name,fetched:!1,following:!0})}),this.updateLocalStorageForTags(),this.dispatchMessage("success","Tags following status updated!",5e3),this.checkTokenExpiry()):this.dispatchMessage("warning","No data or unknown error!",5e3),this.isLoading=!1}).catch(e=>{console.error("Error:",e),this.dispatchMessage("warning",e.message,5e3),this.isLoading=!1}),this.lastFetchFollowingTagsTime=new Date,this.updateLocalStorageForTags()},followTag(e,t=!1){if(!t&&!0===e.following){this.dispatchMessage("warning","Tag already followed!",5e3);return}(!t||!0!==e.following)&&(this.isLoading=!0,fetch(this.FOLLOWING_URL,{method:"POST",headers:{Authorization:`Bearer ${this.access_token}`,"Content-Type":"application/json"},body:JSON.stringify({following_id:`${e.id}`,type:"tag"})}).then(e=>{if(e.redirected)window.location.href=e.url;else if(e.ok)return e.json();else throw Error("Token expired or something went wrong!")}).then(s=>{if(s.id){this.tags=this.tags.map(e=>(e.id===s.id&&(e.following=!0),e));let i=this.followingTags.find(e=>e.id===s.id);i?this.followingTags=this.followingTags.map(e=>(e.id===s.id&&(e.following=!0),e)):this.followingTags.push({id:e.id,name:e.name,following:!0}),this.updateLocalStorageForTags(),t||this.dispatchMessage("success","Tag followed!",5e3),this.checkTokenExpiry()}else{if(t)throw Error("No data or unknown error!");this.dispatchMessage("warning","No data or unknown error!",5e3)}this.isLoading=!1}).catch(e=>{console.error("Error:",e),t||this.dispatchMessage("warning",e.message,5e3),this.isLoading=!1}))},unfollowTag(e,t=!1){if(!t&&!1===e.following){this.dispatchMessage("warning","Tag already unfollowed!",5e3);return}(!t||!1!==e.following)&&(this.isLoading=!0,fetch(this.FOLLOWING_URL,{method:"DELETE",headers:{Authorization:`Bearer ${this.access_token}`,"Content-Type":"application/json"},body:JSON.stringify({following_id:`${e.id}`,type:"tag"})}).then(e=>{if(e.redirected)window.location.href=e.url;else if(e.ok)return e.json();else throw Error("Token expired or something went wrong!")}).then(s=>{!0===s.success?(this.tags=this.tags.map(t=>(t.id===e.id&&(t.following=!1),t)),this.followingTags=this.followingTags.filter(t=>t.id!==e.id),this.recentlyUnfollowedTags.find(t=>t.id===e.id)||this.recentlyUnfollowedTags.push(e),this.updateLocalStorageForTags(),t||this.dispatchMessage("success","Tag unfollowed successfully!",5e3),this.checkTokenExpiry()):this.dispatchMessage("warning","No data or unknown error!",5e3),this.isLoading=!1}).catch(e=>{console.error("Error:",e),t||this.dispatchMessage("warning",e.message,5e3),this.isLoading=!1}))},selectTag(e){e.selected=!e.selected,!0===e.selected?this.selectedTags.push(e):this.selectedTags=this.selectedTags.filter(t=>t.id!==e.id)},selectAll(){this.selectedAll=!this.selectedAll,this.filteredTags=this.filteredTags.map(e=>(e.selected=e.fetched&&this.selectedAll,e)),this.selectedTags=this.selectedAll?this.filteredTags.filter(e=>e.selected):[],console.log("Selected tags:",this.selectedTags)},followSelectedTags(){if(0===this.selectedTags.length){this.dispatchMessage("warning","No tags selected!",5e3);return}if(!confirm("Do you want to follow selected tags?"))return;if(this.getLastFetchTime()>300){if(!confirm("Last fetch was more than 5 minutes ago. Do you want to fetch following status first?"))return;this.fetchFollowingTags();return}this.isLoading=!0,console.log("Following all tags");let e=0,t=()=>{let s=this.selectedTags.slice(e,e+2),i=s.map(e=>this.followTag(e,!0));Promise.all(i).then(()=>{(e+=2)<this.selectedTags.length?setTimeout(t,2e3):(this.isLoading=!1,this.dispatchMessage("success","All selected tags followed!",5e3))}).catch(e=>{console.error("Error in following tags:",e),this.dispatchMessage("warning","Some tags could not be followed.",5e3),this.isLoading=!1})};t()},unFollowSelectedTags(){if(0===this.selectedTags.length){this.dispatchMessage("warning","No tags selected!",5e3);return}if(!confirm("Do you want to unfollow selected tags?"))return;if(this.getLastFetchTime()>300){if(!confirm("Last fetch was more than 5 minutes ago. Do you want to fetch following status first?"))return;this.fetchFollowingTags();return}this.isLoading=!0,console.log("Unfollowing all tags");let e=0,t=()=>{let s=this.selectedTags.slice(e,e+2),i=s.map(e=>this.unfollowTag(e,!0));Promise.all(i).then(()=>{(e+=2)<this.selectedTags.length?setTimeout(t,2e3):(this.isLoading=!1,this.dispatchMessage("success","All tags unfollowed!",5e3))}).catch(e=>{console.error("Error in unfollowing tags:",e),this.dispatchMessage("warning","Some tags could not be unfollowed.",5e3),this.isLoading=!1})};t()},getLastFetchTime(){let e=this.lastFetchFollowingTagsTime||localStorage.getItem("lastFetchFollowingTagsTime");return e?Math.abs(new Date-new Date(e))/1e3:999999999},sortTags(e){this.sortBy===e?this.sortDesc=!this.sortDesc:(this.sortBy=e,this.sortDesc=!1),this.tags.sort((t,s)=>{let i=t[e],a=s[e];return("string"==typeof i&&(i=i.toLowerCase()),"string"==typeof a&&(a=a.toLowerCase()),i<a)?this.sortDesc?1:-1:i>a?this.sortDesc?-1:1:0}),this.updateLocalStorageForTags()},filterTags(){this.filteredTags=this.tags.filter(e=>{let t="all"===this.selectedFollowFilter||e.following==this.selectedFollowFilter,s="all"===this.selectedFetchFilter||e.fetched==this.selectedFetchFilter;return t&&s})},downloadTagsJson(){let e=this.tags.map(e=>({id:e.id,name:e.name,following:e.following,postsUrl:this.getTagPostsUrl(e),wikiUrl:this.getTagWikiUrl(e)})),t=JSON.stringify(e,null,2),s=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(s),a=window.open();a.document.write(`<pre>${t}</pre>`),a.document.close(),URL.revokeObjectURL(i)},directDownloadTagsJson(){let e=this.tags.map(e=>({id:e.id,name:e.name,following:e.following,postsUrl:this.getTagPostsUrl(e),wikiUrl:this.getTagWikiUrl(e)})),t=JSON.stringify(e,null,2),s=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(s),a=document.createElement("a");a.href=i,a.download="tags.json",a.click(),URL.revokeObjectURL(i)}}}window.dispatchMessages=function(e,t){e.forEach(e=>{let s=document.createElement("div");s.className=`notification ${e.type}`,s.innerText=`${e.type.toUpperCase()}: ${e.text}`,document.body.appendChild(s),t>0&&setTimeout(()=>{s.remove()},t)})};